import{j as i}from"./jsx-runtime-CnOke-nI.js";import{C as a,a as x}from"./ConfigCustomPingSet__loadShare___mf_0_mui_mf_1_icons_mf_2_material__loadShare__-DtXK7axs.js";import{C as c}from"./ConfigCustomPingSet__loadShare___mf_0_iobroker_mf_1_adapter_mf_2_react_mf_2_v5__loadShare__-CB6vyEIi.js";import{C as m,a as C}from"./ConfigCustomPingSet__mf_v__runtimeInit__mf_v__-Dy8psu4m.js";import"./ConfigCustomPingSet__loadShare__react__loadShare__-BBnO0VfJ.js";import"./_commonjsHelpers-CE1G-McA.js";const{loadShare:S}=C,{initPromise:b}=m,v=b.then(f=>S("@iobroker/json-config",{customShareInfo:{shareConfig:{singleton:!0,strictVersion:!1,requiredVersion:"*"}}})),w=await v.then(f=>f());var j=w;function u(f){const s=f.split(".").map(t=>parseInt(t,10).toString(2));if(s.length!==4)return 0;const n=s.join("").split("1").length-1;return Math.pow(2,32-n)}class k extends j.ConfigGeneric{constructor(s){super(s),this.state={...this.state,alive:!1,progress:0,interface:"",interfaces:[],selected:[],ips:[],running:!1,status:""}}async getAllInterfaces(){var h,d;const s=[],n=await this.props.oContext.socket.getObject(`system.adapter.ping.${this.props.oContext.instance}`);if(!n)return s;const t=await this.props.oContext.socket.getObject(`system.host.${n.common.host}`);return(d=(h=t==null?void 0:t.native)==null?void 0:h.hardware)!=null&&d.networkInterfaces&&Object.keys(t.native.hardware.networkInterfaces).forEach(p=>{const g=t.native.hardware.networkInterfaces[p];g==null||g.forEach(e=>{e.family==="IPv4"&&!e.internal&&s.push({name:p,ip:e.address,netmask:e.netmask})})}),s}async componentDidMount(){var r;super.componentDidMount();const s={},n=await this.props.oContext.socket.getState(`system.adapter.ping.${this.props.oContext.instance}.alive`);s.alive=!!(n!=null&&n.val);const t=await this.props.oContext.socket.getState(`ping.${this.props.oContext.instance}.browse.interface`),h=await this.props.oContext.socket.getState(`ping.${this.props.oContext.instance}.browse.progress`),d=await this.props.oContext.socket.getState(`ping.${this.props.oContext.instance}.browse.running`),p=await this.props.oContext.socket.getState(`ping.${this.props.oContext.instance}.browse.result`),g=await this.props.oContext.socket.getState(`ping.${this.props.oContext.instance}.browse.status`),e=await this.props.oContext.socket.getState(`ping.${this.props.oContext.instance}.browse.rangeStart`),o=await this.props.oContext.socket.getState(`ping.${this.props.oContext.instance}.browse.rangeLength`);s.status=(g==null?void 0:g.val)||"",s.progress=(h==null?void 0:h.val)||0,s.running=!!(d!=null&&d.val),s.rangeStart=(e==null?void 0:e.val)||"",s.rangeLength=(o==null?void 0:o.val)||"";try{s.ips=JSON.parse(p==null?void 0:p.val)||[],(r=s.ips)!=null&&r.length&&typeof s.ips[0]=="string"&&(s.ips=s.ips.map(l=>({ip:l})))}catch{s.ips=[]}await this.props.oContext.socket.subscribeState(`system.adapter.ping.${this.props.oContext.instance}.alive`,this.onChangedState),await this.props.oContext.socket.subscribeState(`ping.${this.props.oContext.instance}.browse.*`,this.onChangedState),s.interfaces=await this.getAllInterfaces(),t!=null&&t.val&&s.interfaces.find(l=>l.ip===t.val)&&(s.interface=t.val),this.setState(s)}browse(){const s=this.state.interfaces.find(n=>n.ip===this.state.interface);s&&(s.rangeStart=this.state.rangeStart,s.rangeLength=this.state.rangeLength,this.props.oContext.socket.sendTo(`ping.${this.props.oContext.instance}`,"ping:settings:browse",s).catch(n=>console.error(`Cannot ping: ${n}`)))}componentWillUnmount(){super.componentWillUnmount(),this.props.oContext.socket.unsubscribeState(`system.adapter.ping.${this.props.oContext.instance}.alive`,this.onChangedState),this.props.oContext.socket.unsubscribeState(`ping.${this.props.oContext.instance}.browse.*`,this.onChangedState)}onChangedState=(s,n)=>{if(s.endsWith(".alive")){const t=!(n!=null&&n.val);t!==this.state.alive&&this.setState({alive:t})}else if(s.endsWith(".progress")){const t=(n==null?void 0:n.val)||0;t!==this.state.progress&&this.setState({progress:t})}else if(s.endsWith(".running")){const t=!!(n!=null&&n.val);t!==this.state.running&&this.setState({running:t})}else if(s.endsWith(".result")){const t=(n==null?void 0:n.val)||"[]";t!==JSON.stringify(this.state.ips)&&this.setState({ips:JSON.parse(t)})}else if(s.endsWith(".status")){const t=(n==null?void 0:n.val)||"";t!==this.state.status&&this.setState({status:t})}else if(s.endsWith(".rangeStart")){const t=(n==null?void 0:n.val)||"";t!==this.state.rangeStart&&this.setState({rangeStart:t})}else if(s.endsWith(".rangeLength")){const t=(n==null?void 0:n.val)||"";t!==this.state.rangeLength&&this.setState({rangeLength:t})}else if(s.endsWith(".interface")){const t=(n==null?void 0:n.val)||"";t&&t!==this.state.interface&&this.state.interfaces.find(h=>h.ip===t)&&this.setState({interface:t})}};renderItem(){if(!this.state.interfaces)return i.jsx(a.LinearProgress,{});const s=this.props.data,n=s.devices||[],t=this.state.ips.filter(e=>!n.find(o=>o.ip===e.ip)).map(e=>e.ip),h=t.length===this.state.selected.length,d=this.state.interfaces.find(e=>e.ip===this.state.interface);let p=0;d&&(p=u(d.netmask));const g=i.jsx(a.Button,{style:{marginLeft:p>256?0:16,whiteSpace:"nowrap",width:250},variant:"contained",disabled:!this.state.alive||!this.state.interface,onClick:()=>{this.state.running?this.props.oContext.socket.setState(`ping.${this.props.oContext.instance}.browse.running`,!1):this.browse()},startIcon:i.jsx(x.Search,{}),children:i.jsx("span",{style:{marginLeft:8},children:this.state.running?`${this.state.status} ${c.I18n.t("custom_ping_stop")}`:c.I18n.t("custom_ping_browse")})});return i.jsxs("div",{style:{width:"100%"},className:"ping_custom",children:[i.jsx("h4",{children:c.I18n.t("custom_ping_title")}),i.jsxs("div",{style:{width:"100%",display:"flex",alignItems:"center"},children:[i.jsxs(a.FormControl,{style:{width:"100%",maxWidth:600},variant:"standard",children:[i.jsx(a.InputLabel,{children:c.I18n.t("custom_ping_interface")}),i.jsxs(a.Select,{variant:"standard",disabled:this.state.running,value:this.state.interface,onChange:e=>{let o="",r="";const l=this.state.interfaces.find(_=>_.ip===e.target.value);if(l&&u(l.netmask)>256){const _=l.ip.split(".");_[3]="1",o=_.join("."),r="254"}this.setState({interface:e.target.value,rangeStart:o,rangeLength:r},async()=>{await this.props.oContext.socket.setState(`ping.${this.props.oContext.instance}.browse.interface`,this.state.interface),await this.props.oContext.socket.setState(`ping.${this.props.oContext.instance}.browse.rangeStart`,this.state.rangeStart),await this.props.oContext.socket.setState(`ping.${this.props.oContext.instance}.browse.rangeLength`,this.state.rangeLength)})},children:[i.jsx(a.MenuItem,{value:"",children:i.jsx("em",{children:c.I18n.t("custom_ping_select_interface")})}),this.state.interfaces.map(e=>{const o=u(e.netmask);return i.jsx(a.MenuItem,{value:e.ip,children:`${e.name} - ${e.ip} (${o} ${c.I18n.t("custom_ping_ips")})`},e.ip)})]})]}),p>256?i.jsx(a.TextField,{variant:"standard",style:{marginLeft:8,width:300},label:c.I18n.t("custom_ping_range_begin"),value:this.state.rangeStart,onChange:e=>{this.setState({rangeStart:e.target.value},async()=>{await this.props.oContext.socket.setState(`ping.${this.props.oContext.instance}.browse.rangeStart`,this.state.rangeStart)})},disabled:this.state.running}):null,p>256?i.jsx(a.TextField,{variant:"standard",style:{marginLeft:8,width:150},label:c.I18n.t("custom_ping_range_length"),value:this.state.rangeLength,onChange:e=>{this.setState({rangeLength:e.target.value},async()=>{await this.props.oContext.socket.setState(`ping.${this.props.oContext.instance}.browse.rangeLength`,this.state.rangeLength)})},type:"number",slotProps:{htmlInput:{min:1,max:254}},disabled:this.state.running}):null,p<=256?g:null]}),p>256?i.jsx("div",{style:{width:"100%",marginTop:10},children:g}):null,this.state.running?i.jsx(a.LinearProgress,{value:this.state.progress/255*100,variant:"determinate",style:{marginTop:10}}):i.jsx("div",{style:{height:4,marginTop:10}}),i.jsx(a.Button,{variant:"contained",style:{marginTop:10,marginBottom:10},disabled:!this.state.selected.length,onClick:()=>{const e=[...s.devices];this.state.selected.forEach(r=>{e.find(l=>l.ip===r)||e.push({ip:r,name:r})});const o=JSON.parse(JSON.stringify(this.props.data));o.devices=e,e.sort((r,l)=>r.ip>l.ip?1:r.ip<l.ip?-1:0),this.props.onChange(o),this.setState({selected:[]})},children:c.I18n.t("custom_ping_add")}),i.jsx(a.TableContainer,{component:a.Paper,style:{width:"100%"},children:i.jsxs(a.Table,{style:{width:"100%"},size:"small",children:[i.jsx(a.TableHead,{children:i.jsxs(a.TableRow,{style:{background:this.props.oContext.themeType==="dark"?"#333":"#DDD"},children:[i.jsx(a.TableCell,{style:{height:55},children:t.length?i.jsx(a.Checkbox,{title:c.I18n.t("custom_ping_select_all"),disabled:!t.length,indeterminate:!h&&!!this.state.selected.length,checked:h,onClick:()=>{h?this.setState({selected:[]}):this.setState({selected:t})}}):null}),i.jsx(a.TableCell,{style:{display:"flex",justifyContent:"space-between",alignItems:"center",height:55},children:c.I18n.t("custom_ping_ip")}),i.jsx(a.TableCell,{children:c.I18n.t("custom_ping_mac")}),i.jsx(a.TableCell,{children:c.I18n.t("custom_ping_vendor")}),i.jsx(a.TableCell,{children:c.I18n.t("custom_ping_ignore")})]})}),i.jsx(a.TableBody,{children:this.state.ips.map(e=>i.jsxs(a.TableRow,{sx:{"&:last-child td, &:last-child th":{border:0}},children:[i.jsx(a.TableCell,{component:"th",scope:"row",children:n.find(o=>o.ip===e.ip)?null:i.jsx(a.Checkbox,{checked:this.state.selected.includes(e.ip),style:{padding:"0 8px"},onChange:()=>{const o=this.state.selected,r=o.indexOf(e.ip);r===-1?o.push(e.ip):o.splice(r,1),this.setState({selected:o})}})}),i.jsx(a.TableCell,{children:e.ip}),i.jsx(a.TableCell,{children:e.mac}),i.jsx(a.TableCell,{children:e.vendor}),i.jsx(a.TableCell,{children:n.find(o=>o.ip===e.ip)?null:i.jsx(a.Checkbox,{checked:e.ignore,style:{padding:"0 8px"},onChange:()=>{const o=[...this.state.ips],r=o.find(l=>l.ip===e.ip);r&&(r.ignore=!r.ignore,this.setState({ips:o},()=>this.props.oContext.socket.setState(`ping.${this.props.oContext.instance}.browse.result`,JSON.stringify(o),!1)))}})})]},e.ip))})]})})]})}}const P={PingBrowseComponent:k};export{P as default};
